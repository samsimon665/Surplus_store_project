<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Email Verification | Surplus Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-black flex items-center justify-center px-4">

    <div class="w-full max-w-md border border-white/20 rounded-2xl p-10 bg-black text-center">

        <h1 class="text-2xl text-white mb-3">SURPLUS STORE</h1>
        <p class="text-white/60 mb-5">Verify your email to activate your account</p>

        {% if messages %}
        {% for message in messages %}
        <div class="border border-white text-white text-sm py-2 px-3 mb-4 rounded-lg">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Timer text -->
        <p id="timerText" class="text-sm text-white/50 mb-4 hidden"></p>

        <!-- Send button -->
        <form method="post" action="{% url 'accounts:send_verification' %}">
            {% csrf_token %}
            <button id="sendBtn"
                class="w-full py-3 mb-4 border border-white rounded-full text-white hover:bg-white hover:text-black transition">
                Send Verification Email
            </button>
        </form>

        <a href="{% url 'accounts:login' %}" class="text-xs text-white/70 hover:text-white">
            Back to Login
        </a>

    </div>

    <script>
        const sendBtn = document.getElementById("sendBtn");
        const timerText = document.getElementById("timerText");

        // ---------- TIMER FUNCTION ----------
        function startCooldown(seconds) {
            sendBtn.classList.add("hidden");
            timerText.classList.remove("hidden");

            let remaining = seconds;

            const interval = setInterval(() => {
                let min = Math.floor(remaining / 60);
                let sec = remaining % 60;

                timerText.innerText = `You can resend after ${min}:${sec < 10 ? "0" : ""}${sec}`;
                remaining--;

                if (remaining < 0) {
                    clearInterval(interval);
                    timerText.classList.add("hidden");
                    sendBtn.classList.remove("hidden");
                    localStorage.removeItem("cooldownEnd");
                }
            }, 1000);
        }

        // ---------- RESTORE TIMER ON REFRESH ----------
        let cooldownEnd = localStorage.getItem("cooldownEnd");

        if (cooldownEnd) {
            const left = Math.floor((cooldownEnd - Date.now()) / 1000);
            if (left > 0) {
                startCooldown(left);
            } else {
                localStorage.removeItem("cooldownEnd");
            }
        }
    </script>

    {% comment %}
    ---------------------------------------------
    ONLY START TIMER IF EMAIL SENT SUCCESSFULLY
    ---------------------------------------------
    {% endcomment %}

    {% if messages %}
    {% for m in messages %}
    {% if "Verification email sent successfully" in m.message %}
    <script>
        localStorage.setItem("cooldownEnd", Date.now() + (5 * 60 * 1000));
        startCooldown(300);
    </script>
    {% endif %}
    {% endfor %}
    {% endif %}

</body>

</html>