<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surplus - User Profile</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100;400;700" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>


    <style>
        :root {
            --color-bg: #000000;
            --color-accent: #F2E700;
            --color-surface: #111111;
            --color-surface-soft: #141414;
            --color-text: #EEEEEE;
            --color-text-muted: #AAAAAA;
            --font-display: 'Bebas Neue', sans-serif;
            --font-body: 'Montserrat', sans-serif;
            --radius-lg: 18px;
            --radius-pill: 999px;

            --surplus-success: #10b981;
            --surplus-warning: #f59e0b;
            --surplus-danger: #ef4444;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-body);
            overflow-x: hidden;
            /* Navbar height offset if needed */
            padding-top: 80px;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        .h1,
        .h2,
        .h3,
        .h4,
        .h5,
        .display-font,
        .btn {
            font-family: var(--font-display);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Buttons matching categories theme */
        .btn-primary {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: #000;
            font-weight: 600;
            letter-spacing: 1px;
            border-radius: var(--radius-pill);
            padding: 0.5rem 1.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #d9cf00;
            /* Slightly darker accent */
            border-color: #d9cf00;
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(242, 231, 0, 0.4);
        }

        .btn-outline-light {
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--color-text-muted);
            border-radius: var(--radius-pill);
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Custom Card Styles matching categories.html .cat-card feel */
        .card {
            background: #000000 !important;
            border: 1px solid rgba(103, 103, 103, 0.49);
            border-radius: 13px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
            transition: all 0.3s ease;
        }


        .card:hover {
            border-color: rgb(242, 230, 0);
            /* Accent hint on hover */
            /* transform: translateY(-4px); */
            /* Optional hover lift */
        }

        .card-header {
            background-color: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 1.25rem 1.5rem;
        }

        /* Form Controls */
        .form-control,
        .form-select {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-family: var(--font-body);
        }

        .form-control:focus,
        .form-select:focus {
            background-color: rgba(0, 0, 0, 0.5);
            border-color: var(--color-accent);
            color: #fff;
            box-shadow: 0 0 0 2px rgba(242, 231, 0, 0.15);
        }

        .form-control::placeholder {
            color: #666;
        }

        /* Profile Picture */
        .profile-img-container {
            position: relative;
            width: 140px;
            height: 140px;
            margin: 0 auto;
        }

        .profile-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--color-accent);
            padding: 4px;
            /* Space between image and border */
            background-color: var(--color-surface);
        }

        .profile-img-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            background-color: rgba(255, 255, 255, 0.03);
        }

        .material-symbols-outlined {
            vertical-align: middle;
            line-height: 1;
        }

        .profile-edit-badge {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: var(--color-accent);
            color: #000;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid var(--color-surface);
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .profile-edit-badge:hover {
            transform: scale(1.1);
            background-color: #fff;
        }

        /* Progress Bar */
        .progress {
            background-color: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar {
            background-color: var(--color-accent);
        }

        .progress-bar.bg-success {
            background-color: var(--surplus-success) !important;
        }

        /* View/Edit Toggle Animation */
        .view-content,
        .edit-content {
            transition: opacity 0.3s ease, height 0.3s ease;
        }

        .is-editing .view-content {
            display: none;
        }

        .card:not(.is-editing) .edit-content {
            display: none;
        }

        /* Address Card */
        .address-card {
            height: 100%;
            position: relative;
            background: #000000 !important;
            border: 1px solid rgba(255, 255, 255, 0.06);
            /* Subtle contrast against main cards if nested, or stand alone */
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
        }

        .address-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .address-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }



        .modal-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .modal-footer {
            border-top-color: rgba(255, 255, 255, 0.1);
        }

        .btn-close {
            filter: invert(1);
        }

        /* Badges */
        .badge-verified {
            color: var(--surplus-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
            background: rgba(16, 185, 129, 0.05);
            font-weight: 500;
            letter-spacing: 0.5px;
            padding: 0.35em 0.8em;
        }

        .badge-pending {
            color: var(--surplus-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.05);
            font-weight: 500;
            letter-spacing: 0.5px;
            padding: 0.35em 0.8em;
        }

        /* Animations CSS only */
        .fade-in-up {
            opacity: 0;
            animation: fadeInUp 0.8s ease-out forwards;
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        .delay-4 {
            animation-delay: 0.4s;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Text Accent Utility */
        .text-accent {
            color: var(--color-accent) !important;
        }

        .text-muted-soft {
            color: var(--color-text-muted) !important;
        }

        /* ===============================
        PREMIUM PROFILE MODAL
        ================================ */

        .premium-modal {
            background: #000;
            border: 1px solid rgba(242, 231, 0, 0.3);
            border-radius: 24px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.8);
            animation: modalFadeUp 0.3s ease-out;
        }

        .modal-backdrop.show {
            background-color: #000;
            opacity: 0.85;
        }

        .modal-icon {
            width: 70px;
            height: 70px;
            margin: 0 auto;
            border-radius: 50%;
            background: rgba(242, 231, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-icon .material-symbols-outlined {
            font-size: 32px;
            color: #F2E700;
        }

        .premium-btn-primary {
            background: #F2E700;
            color: #000;
            font-weight: 600;
            border-radius: 999px;
            padding: 8px 28px;
            transition: all 0.25s ease;
        }

        .premium-btn-primary:hover {
            background: #000000;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 255, 255, 0.25);
        }

        .premium-btn-outline {
            border-radius: 999px;
            padding: 8px 28px;
        }

        @keyframes modalFadeUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ===============================
        PROFILE CROPPER SIZE FIX
        ================================ */

        .cropper-wrapper {
            position: relative;
            width: 100%;
            height: 75vh;
            /* responsive height */
            background: #111;
            border-radius: 16px;
            overflow: hidden;
        }


        #cropperImage {
            max-width: 100%;
            display: block;
        }

        .otp-box {
            width: 48px;
            height: 52px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: #000;
            color: #fff;
            transition: all 0.2s ease;
        }
        
        .otp-box:focus {
            border-color: #F2E700;
            box-shadow: 0 0 0 2px rgba(242,231,0,0.15);
            outline: none;
        }
        
        .otp-box.filled {
            border-color: #10b981;
        }
    </style>
</head>

<body>

    <!-- Navbar Include Placeholder (Assuming same context) -->
    {% include 'catalog/navbar.html' %}


    <div class="container py-5 mb-5">

        <!-- Header Section -->
        <div class="row mb-5 fade-in-up">
            <div class="col-12 text-center text-md-start">
                <p class="text-accent display-font mb-1" style="letter-spacing:0.25em; font-size:0.9rem;">
                    ACCOUNT SETTINGS
                </p>
                <h1 class="display-3 fw-bold mb-1 text-white">USER <span class="text-accent">PROFILE</span></h1>
                <p class="text-muted-soft" style="max-width: 500px;">Manage your personal information, security
                    settings, and addresses.</p>
            </div>
        </div>



        <div class="row g-4">

            <!-- Left Column: Completion & Profile Image -->
            <div class="col-lg-4 fade-in-up delay-1">




                <!-- Step 1: Profile Picture -->

                <div class="card text-center">
                    <div class="card-body py-5">
                        {% if not profile.profile_pic %}
                        <div class="mb-3">
                            <span class="badge bg-warning text-dark small">
                                Upload image
                            </span>
                        </div>
                        {% endif %}
                        <div class="profile-img-container mb-4">
                            {% if profile.profile_pic %}
                            <img src="{{ profile.profile_pic.url }}" alt="Profile" class="profile-img">
                            {% else %}
                            <div class="profile-img-placeholder">
                                <span class="material-symbols-outlined"
                                    style="font-size: 48px; opacity: 0.5;">person</span>
                            </div>
                            {% endif %}

                            <div class="profile-edit-badge" onclick="handleProfileImageClick()">
                                <span class="material-symbols-outlined fs-5">photo_camera</span>
                            </div>
                        </div>


                        <!-- ðŸ”¥ ADD THIS FORM RIGHT HERE -->
                        <form method="POST" action="{% url 'accounts:update_image' %}" enctype="multipart/form-data"
                            id="profileImageForm">
                            {% csrf_token %}
                            <input type="file" name="profile_pic" id="profileImageInput" accept="image/*"
                                style="display:none;">

                        </form>

                        <h5 class="card-title h3 mb-1 text-white">{{ user.get_full_name|default:user.username }}</h5>

                        <p class="text-muted-soft small mb-0 font-absolute text-uppercase">
                            Member since {{ user.date_joined|date:"M Y" }}
                        </p>

                    </div>
                </div>




                <!-- Completion Card -->


                <div class="card mt-4">
                    <div class="card-body">
                        <h4 class="card-title h5 mb-3">Profile Status</h4>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted-soft small font-body">Completion</span>
                            <span class="fw-bold text-accent">{{ profile.completion_percentage|default:0 }}%</span>
                        </div>
                        <div class="progress mb-4">
                            <div class="progress-bar {% if profile.completion_percentage == 100 %}bg-success{% endif %}"
                                role="progressbar" style="width: {{ profile.completion_percentage|default:0 }}%;"
                                aria-valuenow="{{ profile.completion_percentage|default:0 }}" aria-valuemin="0"
                                aria-valuemax="100">
                            </div>

                        </div>


                        <ul class="list-group list-group-flush bg-transparent">

                            <!-- 1ï¸âƒ£ Profile Picture -->
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0 py-2 border-secondary border-opacity-10">
                                <span class="small text-muted-soft">
                                    <span class="material-symbols-outlined fs-6 me-2 {% if profile.profile_pic %}text-accent{% else %}text-warning{% endif %}">
                                        account_circle
                                    </span>
                                    Profile Picture
                                </span>
                        
                                {% if profile.profile_pic %}
                                    <span class="text-accent material-symbols-outlined fs-5">done</span>
                                {% else %}
                                    <span class="text-warning material-symbols-outlined fs-5">priority_high</span>
                                {% endif %}
                            </li>
                        
                        
                            <!-- 2ï¸âƒ£ Personal Details -->
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0 py-2 border-secondary border-opacity-10">
                                <span class="small text-muted-soft">
                                    <span class="material-symbols-outlined fs-6 me-2 {% if user.first_name and profile.gender and profile.dob %}text-accent{% else %}text-warning{% endif %}">
                                        badge
                                    </span>
                                    Personal Details
                                </span>
                        
                                {% if user.first_name and profile.gender and profile.dob %}
                                    <span class="text-accent material-symbols-outlined fs-5">done</span>
                                {% else %}
                                    <span class="text-warning material-symbols-outlined fs-5">priority_high</span>
                                {% endif %}
                            </li>
                        
                        
                            <!-- 3ï¸âƒ£ Email Verification -->
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0 py-2 border-secondary border-opacity-10">
                                <span class="small text-muted-soft">
                                    <span class="material-symbols-outlined fs-6 me-2 {% if email_verified %}text-accent{% else %}text-warning{% endif %}">
                                        mail
                                    </span>
                                    Email Verified
                                </span>
                        
                                {% if email_verified %}
                                    <span class="text-accent material-symbols-outlined fs-5">done</span>
                                {% else %}
                                    <span class="text-warning material-symbols-outlined fs-5">priority_high</span>
                                {% endif %}
                            </li>
                        
                        
                            <!-- 4ï¸âƒ£ Phone Verification -->
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0 py-2 border-secondary border-opacity-10">
                                <span class="small text-muted-soft">
                                    <span class="material-symbols-outlined fs-6 me-2 {% if profile.phone_verified %}text-accent{% else %}text-warning{% endif %}">
                                        call
                                    </span>
                                    Phone Verified
                                </span>
                        
                                {% if profile.phone_verified %}
                                    <span class="text-accent material-symbols-outlined fs-5">done</span>
                                {% else %}
                                    <span class="text-warning material-symbols-outlined fs-5">priority_high</span>
                                {% endif %}
                            </li>
                        
                        
                            <!-- 5ï¸âƒ£ Address -->
                            <li class="list-group-item bg-transparent d-flex justify-content-between align-items-center px-0 py-2 border-0">
                                <span class="small text-muted-soft">
                                    <span class="material-symbols-outlined fs-6 me-2 {% if addresses %}text-accent{% else %}text-warning{% endif %}">
                                        location_on
                                    </span>
                                    Address Added
                                </span>
                        
                                {% if addresses %}
                                    <span class="text-accent material-symbols-outlined fs-5">done</span>
                                {% else %}
                                    <span class="text-warning material-symbols-outlined fs-5">priority_high</span>
                                {% endif %}
                            </li>
                        
                        </ul>
                    </div>
                </div>




            </div>




            <!-- Right Column: Details & Addresses -->

            <div class="col-lg-8 fade-in-up delay-2">





                <!-- Step 2: Personal Details -->




                <div class="card mb-4" id="personalDetailsCard">
                    <div class="card-header d-flex justify-content-between align-items-center bg-transparent">
                        <h4 class="mb-0 h5 text-white"><span
                                class="material-symbols-outlined me-2 text-accent align-bottom">person</span>Personal
                            Details</h4>
                        <button class="btn btn-sm btn-outline-light d-flex align-items-center gap-2"
                            onclick="toggleEdit('personalDetailsCard')">
                            <span class="material-symbols-outlined fs-6">edit</span> <span
                                class="d-none d-sm-inline">Edit</span>
                        </button>
                    </div>
                    <div class="card-body">




                        <!-- View Mode -->


                        <div class="view-content">
                            <div class="row g-4">
                                <div class="col-sm-6">
                                    <label
                                        class="text-muted-soft small d-block mb-1 text-uppercase letter-spacing-1">Full
                                        Name</label>
                                    <div class="fw-medium text-white fs-5">{{ user.get_full_name|default:"Not set" }}
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <label
                                        class="text-muted-soft small d-block mb-1 text-uppercase letter-spacing-1">Gender</label>
                                    <div class="fw-medium text-white fs-5">{% if profile.gender %}
                                        {{ profile.get_gender_display }}
                                    {% else %}
                                        Not set
                                    {% endif %}
                                    
                                    </div>

                                </div>
                                <div class="col-sm-6">
                                    <label
                                        class="text-muted-soft small d-block mb-1 text-uppercase letter-spacing-1">Date
                                        of Birth</label>
                                    <div class="fw-medium text-white fs-5">{% if profile.dob %}
                                        {{ profile.dob|date:"F j, Y" }}
                                    {% else %}
                                        Not set
                                    {% endif %}
                                     </div>
                                </div>
                                <div class="col-sm-6">
                                    <label
                                        class="text-muted-soft small d-block mb-1 text-uppercase letter-spacing-1">Account
                                        Status</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <span
                                            class="badge rounded-pill border border-success text-success bg-transparent px-3 py-2">
                                            ACTIVE MEMBER
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>





                        <!-- Edit Mode -->


                        <div class="edit-content">
                            <form method="POST" action="{% url 'accounts:update_details' %}">
                                {% csrf_token %}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted-soft">First Name</label>
                                        <input type="text" class="form-control" name="first_name"
                                            value="{{ user.first_name }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted-soft">Last Name</label>
                                        <input type="text" class="form-control" name="last_name"
                                            value="{{ user.last_name }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted-soft">Gender</label>
                                        <select class="form-select" name="gender">
                                            <option value="">Select Gender</option>
                                            <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>Male
                                            </option>
                                            <option value="F" {% if profile.gender == 'F' %}selected{% endif %}>Female
                                            </option>
                                            <option value="O" {% if profile.gender == 'O' %}selected{% endif %}>Other
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small text-muted-soft">Date of Birth</label>
                                        <input type="date" class="form-control" name="dob"
                                            value="{{ profile.dob|date:'Y-m-d' }}">

                                    </div>
                                    <div class="col-12 d-flex justify-content-end gap-2 mt-4">
                                        <button type="button" class="btn btn-outline-light btn-sm"
                                            onclick="toggleEdit('personalDetailsCard')">CANCEL</button>
                                        <button type="submit" class="btn btn-primary btn-sm">SAVE CHANGES</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>





                <!-- Step 3: Contact Info -->

                <div class="row g-4 mb-4">


                    <!-- Email Card -->

                    <div class="col-md-6">
                        <div class="card h-100" id="emailCard">
                            <div class="card-body">

                                {% with email_obj=user.emailaddress_set.first %}

                                <!-- Header -->
                                <div class="d-flex justify-content-between align-items-start mb-4">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="material-symbols-outlined text-accent fs-3">mail</span>
                                        <h6 class="mb-0 fw-bold h5 text-white">EMAIL ADDRESS</h6>
                                    </div>

                                    {% if email_obj and email_obj.verified %}
                                    <span class="badge badge-verified rounded-pill">VERIFIED</span>
                                    {% else %}
                                    <span class="badge badge-verified rounded-pill border-warning text-warning bg-transparent border-opacity-25">
                                        UNVERIFIED
                                    </span>
                                    {% endif %}
                                </div>

                                <!-- VIEW MODE -->
                                <div class="view-content">

                                    {% if not user.email %}

                                        <p class="mb-4 fw-medium fs-5 text-white">
                                            No email added
                                        </p>

                                        <div class="text-center">
                                            <button type="button"
                                                    class="btn btn-sm btn-primary"
                                                    onclick="toggleEdit('emailCard')">
                                                ADD EMAIL
                                            </button>
                                        </div>

                                    {% else %}

                                        <p class="mb-4 text-break fw-medium fs-5 text-white">
                                            {{ user.email }}
                                        </p>

                                        <div class="d-flex gap-2">

                                            <!-- CHANGE BUTTON -->
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-light flex-fill"
                                                    id="changeBtn"
                                                    onclick="toggleEdit('emailCard')">
                                                CHANGE
                                            </button>



                                            {% if email_obj and email_obj.verified %}

                                                <button type="button"
                                                        class="btn btn-sm btn-success flex-fill"
                                                        disabled>
                                                    VERIFIED
                                                </button>

                                            {% else %}

                                                <a href="{% url 'accounts:verify_email' %}"
                                                id="verifyBtn"
                                                class="btn btn-sm btn-warning flex-fill">
                                                    VERIFY
                                                </a>

                                            {% endif %}

                                        </div>

                                    {% endif %}

                                </div>


                                {% endwith %}

                                <!-- EDIT MODE -->
                                <div class="edit-content">
                                    <form method="POST" action="{% url 'accounts:update_email' %}">
                                        {% csrf_token %}
                                
                                        <div class="mb-3">
                                            <input type="email"
                                                   class="form-control"
                                                   name="email"
                                                   value="{{ user.email }}"
                                                   required>
                                
                                        </div>
                                        {% for message in messages %}
                                            {% if "email_error" in message.tags %}
                                                <div class="text-danger small mt-1 mb-4">
                                                    {{ message }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}

                                
                                        <div class="d-flex gap-2">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-light flex-fill"
                                                    onclick="toggleEdit('emailCard')">
                                                CANCEL
                                            </button>
                                
                                            <button type="submit"
                                                    class="btn btn-sm btn-primary flex-fill">
                                                UPDATE EMAIL
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                

                            </div>
                        </div>
                    </div>




                    <!-- Phone Card -->

                    <div class="col-md-6">
                        <div class="card h-100" id="phoneCard">
                            <div class="card-body">

                                <!-- Header -->
                                <div class="d-flex justify-content-between align-items-start mb-4">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="material-symbols-outlined text-accent fs-3">call</span>
                                        <h6 class="mb-0 fw-bold h5 text-white">PHONE NUMBER</h6>
                                    </div>

                                    {% if profile.phone_verified %}
                                        <span class="badge badge-verified rounded-pill">VERIFIED</span>
                                    {% else %}
                                        <span class="badge badge-verified rounded-pill border-warning text-warning bg-transparent border-opacity-25">
                                            UNVERIFIED
                                        </span>
                                    {% endif %}
                                </div>

                                <!-- VIEW MODE -->
                                <div class="view-content">

                                    {% if profile.phone %}
                                        <p class="mb-4 fw-medium fs-5 text-white">
                                            {{ profile.phone }}
                                        </p>
                                    {% else %}
                                        <p class="mb-4 fw-medium fs-5 text-white">
                                            No number added
                                        </p>
                                    {% endif %}

                                    {% if not profile.phone %}

                                        <div class="text-center">
                                            <button type="button"
                                                    class="btn btn-sm btn-primary"
                                                    onclick="toggleEdit('phoneCard')">
                                                ADD PHONE
                                            </button>
                                        </div>

                                    {% else %}

                                        <!-- ACTION ROW -->
                                        <div class="d-flex gap-2 mb-2">

                                            <!-- CHANGE -->
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-light flex-fill"
                                                    id="phoneChangeBtn"
                                                    onclick="toggleEdit('phoneCard')">
                                                CHANGE
                                            </button>

                                            {% if profile.phone_verified %}

                                                <button type="button"
                                                        class="btn btn-sm btn-success flex-fill"
                                                        disabled>
                                                    VERIFIED
                                                </button>

                                            {% else %}

                                            <a href="{% url 'accounts:send_phone_otp' %}"
                                                id="phoneVerifyBtn"
                                                class="btn btn-sm btn-warning flex-fill">
                                                {% if phone_cooldown_remaining > 0 %}
                                                    RESEND IN {{ phone_cooldown_remaining }}s
                                                {% else %}
                                                    VERIFY
                                                {% endif %}
                                            </a>
                                            {% endif %}

                                        </div>

                                        <!-- ENTER OTP -->
                                        {% if phone_otp_remaining > 0 and not profile.phone_verified %}
                                            <div class="d-grid mt-2">
                                                <button type="button"
                                                        id="phoneOtpBtn"
                                                        class="btn btn-sm btn-outline-success"
                                                        onclick="openPhoneOtpModal()">
                                                    ENTER OTP ({{ phone_otp_remaining }}s)
                                                </button>
                                            </div>
                                        {% endif %}

                                    {% endif %}

                                </div>

                                <!-- EDIT MODE -->
                                <div class="edit-content">
                                    <form method="POST" action="{% url 'accounts:update_phone' %}">
                                        {% csrf_token %}

                                        <div class="mb-3">
                                            <input type="tel"
                                                class="form-control"
                                                name="phone"
                                                value="{{ profile.phone|default:'' }}"
                                                placeholder="+1234567890">
                                        </div>

                                        {% for message in messages %}
                                            {% if "phone_update_error" in message.tags %}
                                                <div class="text-danger small mt-1 mb-3">
                                                    {{ message }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}

                                        <div class="d-flex gap-2">
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-light flex-fill"
                                                    onclick="toggleEdit('phoneCard')">
                                                CANCEL
                                            </button>

                                            <button type="submit"
                                                    class="btn btn-sm btn-primary flex-fill">
                                                SAVE NUMBER
                                            </button>
                                        </div>

                                    </form>
                                </div>

                            </div>
                        </div>
                    </div>

                    
                </div>






                <!-- Step 4: Address Book -->

                <div class="card mb-5">
                    <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                        <h4 class="mb-0 h5 text-white"><span
                                class="material-symbols-outlined me-2 text-accent align-bottom">location_on</span>Address
                            Book</h4>


                        <button type="button" class="btn btn-sm btn-primary d-flex align-items-center gap-1"
                            data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            <span class="material-symbols-outlined fs-6">add</span>
                            ADD ADDRESS
                        </button>




                    </div>
                    <div class="card-body p-4">
                        {% if addresses %}
                        <div class="row g-3">
                            {% for address in addresses %}
                            <div class="col-md-6 col-xl-6">
                                <div class="card address-card h-100" {% if address.is_default %}
                                    style="border:2px solid #F2E700;" {% endif %}>

                                    <div class="card-body p-4">
                                        {% if address.is_default %}
                                        <div class="mb-3">
                                            <span class="badge"
                                                style="background-color:#F2E700; color:#000; font-weight:600;">
                                                DEFAULT
                                            </span>
                                        </div>
                                        {% else %}
                                        <div class="mb-3" style="min-height:22px;"></div>
                                        {% endif %}


                                        <div class="dropdown address-actions">
                                            <button class="btn btn-link text-muted-soft p-0" type="button"
                                                data-bs-toggle="dropdown">
                                                <span class="material-symbols-outlined">more_vert</span>
                                            </button>
                                            <ul
                                                class="dropdown-menu dropdown-menu-end dropdown-menu-dark border border-secondary border-opacity-25 shadow-lg">
                                                <li>
                                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                                        href="{% url 'accounts:profile' %}?edit={{ address.id }}">
                                                        <span class="material-symbols-outlined fs-6">edit</span>
                                                        Edit
                                                    </a>
                                                </li>

                                                {% if not address.is_default %}
                                                <li>
                                                    <form method="POST"
                                                        action="{% url 'accounts:set_default_address' address.id %}">
                                                        {% csrf_token %}
                                                        <button class="dropdown-item d-flex align-items-center gap-2"
                                                            type="submit">
                                                            <span class="material-symbols-outlined fs-6">star</span>
                                                            Make Default
                                                        </button>
                                                    </form>

                                                </li>
                                                {% endif %}
                                                <li>
                                                    <hr class="dropdown-divider border-secondary border-opacity-25">
                                                </li>
                                                <li>
                                                    <form method="POST"
                                                        action="{% url 'accounts:delete_address' address.id %}">
                                                        {% csrf_token %}
                                                        <button
                                                            class="dropdown-item text-danger d-flex align-items-center gap-2"
                                                            type="submit">
                                                            <span class="material-symbols-outlined fs-6">delete</span>
                                                            Delete
                                                        </button>
                                                    </form>

                                                </li>
                                            </ul>
                                        </div>

                                        <h6 class="fw-bold mb-2 text-white h5">
                                            {{ address.full_name }}
                                        </h6>

                                        <div class="text-secondary small mb-0">
                                            <div class="text-white">{{ address.address_line_1 }}</div>

                                            {% if address.address_line_2 %}
                                            <div class="text-white">{{ address.address_line_2 }}</div>
                                            {% endif %}

                                            {% if address.landmark %}
                                            <div class="text-white">{{ address.landmark }}</div>
                                            {% endif %}

                                            <div class="text-white">
                                                {{ address.city }}, {{ address.district }},
                                                {{ address.state }} - {{ address.pincode }}
                                            </div>

                                            <div class="text-white">
                                                {{ address.country }}
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            {% endfor %}
                        </div>
                        {% else %}

                        <!-- Empty State -->

                        <div class="text-center py-5">
                            <div
                                class="bg-secondary bg-opacity-10 p-4 rounded-circle d-inline-block mb-3 border border-secondary border-opacity-25">
                                <span class="material-symbols-outlined fs-1 text-muted-soft"
                                    style="font-size: 3rem;">location_off</span>
                            </div>
                            <h6 class="text-white fw-bold h5">NO ADDRESSES FOUND</h6>
                            <p class="text-muted-soft small mb-4">Add a shipping address to speed up checkout.</p>


                            <button type="button" class="btn btn-primary"
                                data-bs-toggle="modal" data-bs-target="#addAddressModal">
                                ADD NEW ADDRESS
                            </button>

                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </div>

    </div>



    <!-- Step 4 Modal: Add Address -->

    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold h4">ADD NEW ADDRESS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{% url 'accounts:add_address' %}">
                    {% csrf_token %}

                    {% if editing_address_id %}
                    <input type="hidden" name="address_id" value="{{ editing_address_id }}">
                    {% endif %}

                    <div class="modal-body">
                        <div class="row g-3">

                            <div class="col-12">
                                <label class="form-label small text-muted-soft">Full Name</label>
                                {{ address_form.full_name }}
                                {% if address_form.full_name.errors %}
                                <div class="text-danger small">
                                    {{ address_form.full_name.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted-soft">Address Line</label>
                                {{ address_form.address_line_1 }}
                                {% if address_form.address_line_1.errors %}
                                <div class="text-danger small">
                                    {{ address_form.address_line_1.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted-soft">Landmark</label>
                                {{ address_form.landmark }}
                                {% if address_form.landmark.errors %}
                                <div class="text-danger small">
                                    {{ address_form.landmark.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-6">
                                <label class="form-label small text-muted-soft">City</label>
                                {{ address_form.city }}
                                {% if address_form.city.errors %}
                                <div class="text-danger small">
                                    {{ address_form.city.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-6">
                                <label class="form-label small text-muted-soft">District</label>
                                {{ address_form.district }}
                                {% if address_form.district.errors %}
                                <div class="text-danger small">
                                    {{ address_form.district.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-6">
                                <label class="form-label small text-muted-soft">State</label>
                                {{ address_form.state }}
                                {% if address_form.state.errors %}
                                <div class="text-danger small">
                                    {{ address_form.state.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-6">
                                <label class="form-label small text-muted-soft">Pincode</label>
                                {{ address_form.pincode }}
                                {% if address_form.pincode.errors %}
                                <div class="text-danger small">
                                    {{ address_form.pincode.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <label class="form-label small text-muted-soft">Country</label>
                                {{ address_form.country }}
                                {% if address_form.country.errors %}
                                <div class="text-danger small">
                                    {{ address_form.country.errors.0 }}
                                </div>
                                {% endif %}
                            </div>

                            <div class="col-12">
                                <div class="form-check">
                                    {{ address_form.is_default }}
                                    <label class="form-check-label small text-white">
                                        Set as default address
                                    </label>
                                </div>
                            </div>

                        </div>
                    </div>


                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-light btn-sm" data-bs-dismiss="modal">
                            CANCEL
                        </button>

                        <button type="submit" class="btn btn-primary btn-sm">
                            {% if editing_address_id %}
                            UPDATE ADDRESS
                            {% else %}
                            SAVE ADDRESS
                            {% endif %}
                        </button>
                    </div>
                </form>


            </div>
        </div>
    </div>






    <!-- Footer similar to categories -->

    <footer class="mt-5"
        style="border-top: 1px solid rgba(255, 255, 255, 0.12); background: #050505; padding: 52px 0 30px;">
        <div class="container">
            <div class="row align-items-center mb-4">
                <div class="col-md-4 text-center text-md-start mb-3 mb-md-0">
                    <div class="h5 mb-0 font-display text-white"
                        style="font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.18em;">SURPLUS<span
                            class="text-accent">STORE</span></div>
                    <div class="text-muted-soft small mt-1">Premium surplus clothing by weight.</div>
                </div>
                <div class="col-md-4 text-center mb-3 mb-md-0">
                    <a href="#" class="text-decoration-none text-muted-soft small mx-2">ABOUT</a>
                    <a href="#" class="text-decoration-none text-muted-soft small mx-2">CONTACT</a>
                    <a href="#" class="text-decoration-none text-muted-soft small mx-2">FAQ</a>
                </div>
                <div class="col-md-4 text-center text-md-end">
                    <span class="text-muted-soft small">&copy; {% now "Y" %} SURPLUS. ALL RIGHTS RESERVED.</span>
                </div>
            </div>
        </div>
    </footer>


    <div class="modal fade" id="profileConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content premium-modal">

                <div class="modal-body text-center p-5">

                    <div class="modal-icon mb-4">
                        <span class="material-symbols-outlined">
                            photo_camera
                        </span>
                    </div>

                    <h4 class="mb-3 fw-bold text-white">
                        Replace Profile Picture?
                    </h4>

                    <p class="text-muted-soft mb-4">
                        You already have a profile image.<br>
                        This action will replace the existing one.
                    </p>

                    <div class="d-flex justify-content-center gap-3 mt-4">
                        <button type="button" class="btn btn-outline-light premium-btn-outline" data-bs-dismiss="modal">
                            Cancel
                        </button>

                        <button type="button" class="btn premium-btn-primary" id="confirmContinue">
                            Continue
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="cropperModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content premium-modal p-4">

                <h5 class="text-white mb-3">Crop Image</h5>

                <div class="cropper-wrapper">
                    <img id="cropperImage">
                </div>


                <div class="d-flex justify-content-end gap-3 mt-4">
                    <button class="btn btn-outline-light" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button class="btn premium-btn-primary" id="cropConfirm">
                        Crop & Save
                    </button>
                </div>

            </div>
        </div>
    </div>





    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <!-- Simple Toggle Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.toggleEdit = function (cardId) {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.toggle('is-editing');
                }
            };
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        
            window.handleProfileImageClick = function () {
        
                const hasImage = "{{ profile.profile_pic|yesno:'true,false' }}" === "true";
        
                if (hasImage) {
                    const modal = new bootstrap.Modal(
                        document.getElementById('profileConfirmModal')
                    );
                    modal.show();
                } else {
                    document.getElementById("profileImageInput").click();
                }
            };
        
            const confirmBtn = document.getElementById("confirmContinue");
        
            if (confirmBtn) {
                confirmBtn.addEventListener("click", function () {
        
                    const modalEl = document.getElementById('profileConfirmModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
        
                    document.getElementById("profileImageInput").click();
                });
            }
        
        });
    </script>
        

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const input = document.getElementById("profileImageInput");
            const form = document.getElementById("profileImageForm");

            const cropModalEl = document.getElementById("cropperModal");
            const cropModal = new bootstrap.Modal(cropModalEl);

            const cropImage = document.getElementById("cropperImage");
            const cropConfirm = document.getElementById("cropConfirm");

            let cropper = null;

            /* ===============================
               When file selected â†’ open cropper
            =============================== */

            input.addEventListener("change", function () {

                if (!this.files || !this.files[0]) return;

                const file = this.files[0];

                if (!file.type.startsWith("image/")) {
                    alert("Please select a valid image");
                    input.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {

                    cropImage.src = e.target.result;

                    cropModal.show();

                    // Wait until modal is fully visible
                    cropModalEl.addEventListener('shown.bs.modal', function handler() {

                        // Remove listener after first run
                        cropModalEl.removeEventListener('shown.bs.modal', handler);

                        if (cropper) cropper.destroy();

                        cropper = new Cropper(cropImage, {
                            aspectRatio: 1,
                            viewMode: 1,
                            responsive: true,
                            autoCropArea: 0.9,
                            background: false
                        });

                    }, { once: true });
                };

                reader.readAsDataURL(file);
            });

            /* ===============================
               Confirm crop
            =============================== */

            cropConfirm.addEventListener("click", function () {

                if (!cropper) return;

                cropper.getCroppedCanvas({
                    width: 500,
                    height: 500,
                    imageSmoothingQuality: "high"
                }).toBlob(function (blob) {

                    const croppedFile = new File(
                        [blob],
                        "profile.jpg",
                        { type: "image/jpeg" }
                    );

                    const dt = new DataTransfer();
                    dt.items.add(croppedFile);
                    input.files = dt.files;

                    cropper.destroy();
                    cropper = null;

                    cropModal.hide();

                    form.submit(); // finally submit

                }, "image/jpeg", 0.9);
            });

        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            {% if address_form.errors or editing_address_id or add_mode %}
            var modal = new bootstrap.Modal(
                document.getElementById('addAddressModal')
            );
            modal.show();
            {% endif %}

        });
    </script>


    {% if messages %}
    <script>
    document.addEventListener("DOMContentLoaded", function() {

        {% for message in messages %}

            {% if "email_sent" in message.tags %}
                var modal = new bootstrap.Modal(
                    document.getElementById('emailSentModal')
                );
                modal.show();
            {% endif %}

            {% if "email_verified" in message.tags %}
                var modal = new bootstrap.Modal(
                    document.getElementById('emailVerifiedModal')
                );
                modal.show();
            {% endif %}

        {% endfor %}

    });
    </script>
    {% endif %}



    <script>
        document.addEventListener("DOMContentLoaded", function () {
        
            const verifyBtn = document.getElementById("verifyBtn");
            const changeBtn = document.getElementById("changeBtn");
        
            if (!verifyBtn) return;
        
            const lastSent = "{{ request.session.last_verification_sent|default:'' }}";
        
            if (lastSent) {
                const sentTime = new Date(lastSent);
                const now = new Date();
        
                const diff = Math.floor((now - sentTime) / 1000);
                const remaining = 120 - diff;
        
                if (remaining > 0) {
                    startCountdown(remaining);
                }
            }
        
            function startCountdown(seconds) {
        
                // Disable VERIFY
                verifyBtn.classList.add("disabled");
                verifyBtn.style.pointerEvents = "none";
        
                // Disable CHANGE
                if (changeBtn) {
                    changeBtn.classList.add("disabled");
                    changeBtn.style.pointerEvents = "none";
                    changeBtn.style.opacity = "0.6";
                }
        
                let remaining = seconds;
        
                const interval = setInterval(function () {
        
                    verifyBtn.innerText = "RESEND IN " + remaining + "s";
        
                    remaining--;
        
                    if (remaining < 0) {
                        clearInterval(interval);
        
                        verifyBtn.innerText = "VERIFY";
                        verifyBtn.classList.remove("disabled");
                        verifyBtn.style.pointerEvents = "auto";
        
                        // Enable CHANGE again
                        if (changeBtn) {
                            changeBtn.classList.remove("disabled");
                            changeBtn.style.pointerEvents = "auto";
                            changeBtn.style.opacity = "1";
                        }
                    }
        
                }, 1000);
            }
        
        });
        </script>
        


    {% comment %} EMAIL UPDATE ERROR {% endcomment %}

    {% if messages %}
    <script>
    document.addEventListener("DOMContentLoaded", function() {

        {% for message in messages %}
            {% if "email_error" in message.tags %}
                document.getElementById("emailCard").classList.add("is-editing");
            {% endif %}
        {% endfor %}

    });
    </script>
    {% endif %}




    {% comment %} PHONE UPDATE ERROR  {% endcomment %}
    
    {% if messages %}f
    <script>
    document.addEventListener("DOMContentLoaded", function() {

        {% for message in messages %}
            {% if "phone_update_error" in message.tags %}
                document.getElementById("phoneCard").classList.add("is-editing");
            {% endif %}
        {% endfor %}

    });
    </script>
    {% endif %}




    {% comment %} PHONE OTP SEND  {% endcomment %}

    {% if messages %}
    <script>
    document.addEventListener("DOMContentLoaded", function() {

        {% for message in messages %}
            {% if "phone_sent" in message.tags %}
                var modal = new bootstrap.Modal(
                    document.getElementById('phoneOtpModal')
                );
                modal.show();
                startOtpTimer();
            {% endif %}
        {% endfor %}

    });
    </script>
    {% endif %}

    {% comment %} PHONE OTP ERROR {% endcomment %}

    {% if messages %}
    <script>
    document.addEventListener("DOMContentLoaded", function() {

        {% for message in messages %}
            {% if "phone_otp_error" in message.tags %}
                var modal = new bootstrap.Modal(
                    document.getElementById('phoneOtpModal')
                );
                modal.show();
                startOtpTimer();
            {% endif %}
        {% endfor %}

    });
    </script>
    {% endif %}


    {% comment %} OTP TIMER {% endcomment %}

    <script>
        function startOtpTimer() {
        
            let seconds = {{ phone_otp_remaining|default:0 }};
        
            const timerEl = document.getElementById("otpTimer");
        
            if (!timerEl || seconds <= 0) return;
        
            timerEl.innerText = seconds;
        
            const interval = setInterval(function() {
        
                seconds--;
                timerEl.innerText = seconds;
        
                if (seconds <= 0) {
                    clearInterval(interval);
                    timerEl.innerText = "Expired";
                }
        
            }, 1000);
        }
    </script>


        {% comment %} VERIFY BUTTON TIMER {% endcomment %}


        <script>
            document.addEventListener("DOMContentLoaded", function () {
            
                const verifyBtn = document.getElementById("phoneVerifyBtn");
                const changeBtn = document.getElementById("phoneChangeBtn");
            
                if (!verifyBtn) return;
            
                let remaining = {{ phone_cooldown_remaining|default:0 }};
            
                if (remaining > 0) {
                    startPhoneCooldown(remaining);
                }
            
                function startPhoneCooldown(seconds) {
            
                    verifyBtn.classList.add("disabled");
                    verifyBtn.style.pointerEvents = "none";
            
                    if (changeBtn) {
                        changeBtn.classList.add("disabled");
                        changeBtn.style.pointerEvents = "none";
                        changeBtn.style.opacity = "0.6";
                    }
            
                    let time = seconds;
            
                    const interval = setInterval(function () {
            
                        verifyBtn.innerText = "RESEND IN " + time + "s";
                        time--;
            
                        if (time < 0) {
                            clearInterval(interval);
            
                            verifyBtn.innerText = "VERIFY";
                            verifyBtn.classList.remove("disabled");
                            verifyBtn.style.pointerEvents = "auto";
            
                            if (changeBtn) {
                                changeBtn.classList.remove("disabled");
                                changeBtn.style.pointerEvents = "auto";
                                changeBtn.style.opacity = "1";
                            }
                        }
            
                    }, 1000);
                }
            
            });
        </script>



        {% comment %} ENTER OTP BUTTON TIMER  {% endcomment %}


        <script>
            document.addEventListener("DOMContentLoaded", function () {
            
                const btn = document.getElementById("phoneOtpBtn");
                if (!btn) return;
            
                let remaining = {{ phone_otp_remaining|default:0 }};
            
                const interval = setInterval(function () {
            
                    remaining--;
            
                    if (remaining <= 0) {
                        clearInterval(interval);
                        btn.remove();
                        return;
                    }
            
                    btn.innerText = "ENTER OTP (" + remaining + "s)";
            
                }, 1000);
            
            });
        </script>

        {% comment %} OTP REOPEN  {% endcomment %}


        <script>
            function openPhoneOtpModal() {
                var modal = new bootstrap.Modal(
                    document.getElementById('phoneOtpModal')
                );
                modal.show();
            }
        </script>


        {% comment %} OTP SIX BOX  {% endcomment %}


        <script>
            document.addEventListener("DOMContentLoaded", function () {
            
                const inputs = document.querySelectorAll("#otpInputs .otp-box");
                const hiddenInput = document.getElementById("finalOtpInput");
            
                if (!inputs.length) return;
            
                inputs.forEach((input, index) => {
            
                    input.addEventListener("input", function () {
            
                        this.value = this.value.replace(/[^0-9]/g, "");
            
                        if (this.value.length === 1) {
                            this.classList.add("filled");
            
                            if (index < inputs.length - 1) {
                                inputs[index + 1].focus();
                            }
                        }
            
                        updateHiddenInput();
                    });
            
                    input.addEventListener("keydown", function (e) {
            
                        if (e.key === "Backspace" && !this.value && index > 0) {
                            inputs[index - 1].focus();
                        }
                    });
            
                });
            
                function updateHiddenInput() {
                    let otp = "";
                    inputs.forEach(i => otp += i.value);
                    hiddenInput.value = otp;
                }
            
            });
        </script>


        {% if messages %}
        <script>
        document.addEventListener("DOMContentLoaded", function() {

            {% for message in messages %}

                {% if "phone_attempts_exceeded" in message.tags %}
                    var modal = new bootstrap.Modal(
                        document.getElementById('phoneAttemptsModal')
                    );
                    modal.show();
                {% endif %}

            {% endfor %}

        });
        </script>
        {% endif %}
        
    



    <div class="modal fade" id="emailSentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content premium-modal p-4 text-center">
    
                <div class="modal-icon mb-4">
                    <span class="material-symbols-outlined">
                        mail
                    </span>
                </div>
    
                <h5 class="text-white mb-3">Verification Email Sent</h5>
                <p class="text-muted-soft">
                    Please check your inbox and click the verification link.
                </p>
    
                <button class="btn premium-btn-primary mt-3" data-bs-dismiss="modal">
                    OK
                </button>
    
            </div>
        </div>
    </div>

    <div class="modal fade" id="emailVerifiedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content premium-modal p-4 text-center">
    
                <div class="modal-icon mb-4">
                    <span class="material-symbols-outlined">
                        check_circle
                    </span>
                </div>
    
                <h5 class="text-white mb-3">Email Verified Successfully</h5>
                <p class="text-muted-soft">
                    Your email address has been confirmed.
                </p>
    
                <button class="btn premium-btn-primary mt-3" data-bs-dismiss="modal">
                    OK
                </button>
    
            </div>
        </div>
    </div>

    <div class="modal fade" id="phoneOtpModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content premium-modal p-4 text-center">
    
                <div class="modal-icon mb-4">
                    <span class="material-symbols-outlined">
                        call
                    </span>
                </div>
    
                <h5 class="text-white mb-3">Enter OTP</h5>
                <p class="text-muted-soft small mb-3">
                    OTP sent to {{ profile.phone }}
                </p>

                {% for message in messages %}
                    {% if "phone_otp_error" in message.tags %}
                        <div class="text-danger small mb-3 text-center">
                            {{ message }}
                        </div>
                    {% endif %}
                {% endfor %}
    
                <form method="POST" action="{% url 'accounts:verify_phone_otp' %}">
                    {% csrf_token %}
    
                    <div class="d-flex justify-content-center gap-2 mb-3" id="otpInputs">

                        <input type="text" maxlength="1" class="otp-box" />
                        <input type="text" maxlength="1" class="otp-box" />
                        <input type="text" maxlength="1" class="otp-box" />
                        <input type="text" maxlength="1" class="otp-box" />
                        <input type="text" maxlength="1" class="otp-box" />
                        <input type="text" maxlength="1" class="otp-box" />
                    
                    </div>
                    
                    <!-- Hidden actual field -->
                    <input type="hidden" name="otp" id="finalOtpInput">
    
                    <div class="text-warning small mb-3">
                        Expires in <span id="otpTimer">120</span>s
                    </div>
    
                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-light flex-fill"
                                data-bs-dismiss="modal">
                            Cancel
                        </button>
    
                        <button type="submit"
                                class="btn premium-btn-primary flex-fill">
                            Verify
                        </button>
                    </div>
                </form>
    
            </div>
        </div>
    </div>


    {% comment %} THREE ATTEMPT FAILURE ERROR {% endcomment %}


    <div class="modal fade" id="phoneAttemptsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content premium-modal p-4 text-center">
    
                <div class="modal-icon mb-4">
                    <span class="material-symbols-outlined">
                        error
                    </span>
                </div>
    
                <h5 class="text-white mb-3">
                    Verification Failed
                </h5>
    
                <p class="text-danger">
                    You have failed 3 attempts. Please request a new OTP.
                </p>
    
                <button class="btn btn-sm btn-primary mt-3"
                        data-bs-dismiss="modal">
                    CLOSE
                </button>
    
            </div>
        </div>
    </div>
    
    



</body>

</html>